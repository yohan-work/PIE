name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  quality-check:
    name: ğŸ“‹ Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” HTML Lint
        run: npx htmlhint **/*.html
        continue-on-error: true

      - name: ğŸ¨ CSS Lint
        run: npx stylelint **/*.css --config .stylelintrc.json
        continue-on-error: true

      - name: âœ¨ Format Check
        run: npx prettier --check **/*.{html,css,js,json}
        continue-on-error: true

  # ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸
  accessibility-test:
    name: â™¿ Accessibility Test
    runs-on: ubuntu-latest
    needs: quality-check

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸŒ Start server
        run: |
          npm run serve &
          sleep 5
          curl -f http://localhost:3000 || exit 1

      - name: â™¿ Run Pa11y accessibility test
        run: |
          # ë©”ì¸ í˜ì´ì§€ í…ŒìŠ¤íŠ¸
          npx pa11y http://localhost:3000 \
            --reporter json \
            --timeout 10000 \
            --wait 2000 \
            --chromium-flags="--no-sandbox --disable-setuid-sandbox --disable-dev-shm-usage" > pa11y-report-index.json

          # About í˜ì´ì§€ í…ŒìŠ¤íŠ¸
          npx pa11y http://localhost:3000/about.html \
            --reporter json \
            --timeout 10000 \
            --wait 2000 \
            --chromium-flags="--no-sandbox --disable-setuid-sandbox --disable-dev-shm-usage" > pa11y-report-about.json

          # ë¦¬í¬íŠ¸ í•©ì¹˜ê¸°
          echo "[]" | jq '. + input + input' pa11y-report-index.json pa11y-report-about.json > pa11y-report.json
        continue-on-error: false

      - name: ğŸ”¬ Run axe-core accessibility test
        run: |
          # ë©”ì¸ í˜ì´ì§€ í…ŒìŠ¤íŠ¸
          npx @axe-core/cli http://localhost:3000 \
            --output axe-report-index.json \
            --format json

          # About í˜ì´ì§€ í…ŒìŠ¤íŠ¸  
          npx @axe-core/cli http://localhost:3000/about.html \
            --output axe-report-about.json \
            --format json

          # ë©”ì¸ í˜ì´ì§€ ê²°ê³¼ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš© (about ê²°ê³¼ëŠ” ë³„ë„ í™•ì¸)
          cp axe-report-index.json axe-report.json
        continue-on-error: false

      - name: ğŸ“Š Generate accessibility summary
        run: |
          node -e "
            const fs = require('fs');
            
            // Pa11y ë¦¬í¬íŠ¸ ì²˜ë¦¬
            let pa11yReport = {};
            if (fs.existsSync('pa11y-report.json')) {
              try {
                pa11yReport = JSON.parse(fs.readFileSync('pa11y-report.json', 'utf8'));
              } catch (e) {
                console.log('Pa11y ë¦¬í¬íŠ¸ íŒŒì‹± ì‹¤íŒ¨:', e.message);
              }
            }

            // Axe ë¦¬í¬íŠ¸ ì²˜ë¦¬  
            let axeReport = {};
            if (fs.existsSync('axe-report.json')) {
              try {
                axeReport = JSON.parse(fs.readFileSync('axe-report.json', 'utf8'));
              } catch (e) {
                console.log('Axe ë¦¬í¬íŠ¸ íŒŒì‹± ì‹¤íŒ¨:', e.message);
              }
            }

            const summary = {
              timestamp: new Date().toISOString(),
              pa11y: {
                issues: Array.isArray(pa11yReport) ? pa11yReport.length : 0,
                details: pa11yReport
              },
              axe: {
                violations: axeReport.violations ? axeReport.violations.length : 0,
                passes: axeReport.passes ? axeReport.passes.length : 0,
                details: axeReport
              }
            };

            fs.writeFileSync('accessibility-summary.json', JSON.stringify(summary, null, 2));
            console.log('ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ ì™„ë£Œ:');
            console.log('- Pa11y ì´ìŠˆ:', summary.pa11y.issues);
            console.log('- Axe ìœ„ë°˜ì‚¬í•­:', summary.axe.violations);
            console.log('- Axe í†µê³¼í•­ëª©:', summary.axe.passes);
          "

      - name: ğŸ“¤ Upload accessibility reports
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-reports
          path: |
            pa11y-report.json
            axe-report.json
            accessibility-summary.json
          retention-days: 30

  # ìŠ¤ëƒ…ìƒ· í…ŒìŠ¤íŠ¸
  visual-test:
    name: ğŸ“¸ Visual Regression Test
    runs-on: ubuntu-latest
    needs: quality-check

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install --with-deps

      - name: ğŸŒ Start server for testing
        run: |
          npm run serve &
          sleep 5
          curl -f http://localhost:3000 || exit 1

      - name: ğŸ“¸ Run Playwright visual tests
        run: npx playwright test
        continue-on-error: true

      - name: ğŸ“¤ Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: |
            test-results/
            playwright-report/
          retention-days: 30

  # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  performance-test:
    name: âš¡ Performance Test
    runs-on: ubuntu-latest
    needs: quality-check

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸŒ Start server
        run: |
          npm run serve &
          sleep 5

      - name: ğŸš€ Run Lighthouse CI
        run: |
          npx lighthouse http://localhost:3000 \
            --output json \
            --output-path lighthouse-report.json \
            --chrome-flags="--headless --no-sandbox"

      - name: ğŸ“Š Performance summary
        run: |
          node -e "
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('lighthouse-report.json', 'utf8'));
            const categories = report.categories;
            
            console.log('ğŸ“Š Lighthouse ì„±ëŠ¥ ì ìˆ˜:');
            console.log('- ì„±ëŠ¥:', Math.round(categories.performance.score * 100));
            console.log('- ì ‘ê·¼ì„±:', Math.round(categories.accessibility.score * 100));
            console.log('- ëª¨ë²”ì‚¬ë¡€:', Math.round(categories['best-practices'].score * 100));
            console.log('- SEO:', Math.round(categories.seo.score * 100));
          "

      - name: ğŸ“¤ Upload Lighthouse report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: lighthouse-report.json
          retention-days: 30

  # ë¯¸ë¦¬ë³´ê¸° ë°°í¬ (PRìš©)
  deploy-preview:
    name: ğŸŒ Deploy Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [accessibility-test, visual-test, performance-test]

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build
        run: npm run build

      - name: ğŸš€ Deploy to Vercel (Preview)
        id: vercel-deploy
        run: |
          npx vercel --token ${{ secrets.VERCEL_TOKEN }} \
            --scope ${{ secrets.VERCEL_ORG_ID }} \
            --confirm dist > deployment-url.txt
          echo "url=$(cat deployment-url.txt)" >> $GITHUB_OUTPUT
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        continue-on-error: true

      - name: ğŸ“ Comment PR with preview URL
        uses: actions/github-script@v7
        if: steps.vercel-deploy.outcome == 'success'
        with:
          script: |
            const deploymentUrl = '${{ steps.vercel-deploy.outputs.url }}';

            const comment = `## ğŸš€ ë¯¸ë¦¬ë³´ê¸° ë°°í¬ ì™„ë£Œ

            **ë°°í¬ URL**: ${deploymentUrl}

            ### ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼
            - âœ… ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ
            - â™¿ ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰ë¨
            - ğŸ“¸ ìŠ¤ëƒ…ìƒ· í…ŒìŠ¤íŠ¸ ì‹¤í–‰ë¨  
            - âš¡ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ë¨

            ìì„¸í•œ ê²°ê³¼ëŠ” Actions íƒ­ì—ì„œ í™•ì¸í•˜ì„¸ìš”.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # í”„ë¡œë•ì…˜ ë°°í¬ (main ë¸Œëœì¹˜)
  deploy-production:
    name: ğŸš€ Deploy Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [accessibility-test, visual-test, performance-test]
    environment: production

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build
        run: npm run build

      - name: ğŸš€ Deploy to Vercel (Production)
        run: |
          npx vercel --prod --token ${{ secrets.VERCEL_TOKEN }} \
            --scope ${{ secrets.VERCEL_ORG_ID }} \
            --confirm dist
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        continue-on-error: true

  # ì¢…í•© ë¦¬í¬íŠ¸ ìƒì„±
  generate-report:
    name: ğŸ“‹ Generate Comprehensive Report
    runs-on: ubuntu-latest
    if: always()
    needs: [accessibility-test, visual-test, performance-test]

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: ğŸ“Š Generate comprehensive report
        run: |
          node -e "
            const fs = require('fs');
            const path = require('path');
            
            const report = {
              timestamp: new Date().toISOString(),
              commit: process.env.GITHUB_SHA,
              branch: process.env.GITHUB_REF_NAME,
              workflow: process.env.GITHUB_WORKFLOW,
              results: {}
            };
            
            // ì ‘ê·¼ì„± ë¦¬í¬íŠ¸ ìˆ˜ì§‘
            const a11yPath = './artifacts/accessibility-reports';
            if (fs.existsSync(a11yPath)) {
              try {
                const summaryPath = path.join(a11yPath, 'accessibility-summary.json');
                if (fs.existsSync(summaryPath)) {
                  report.results.accessibility = JSON.parse(fs.readFileSync(summaryPath, 'utf8'));
                }
              } catch (e) {
                console.log('ì ‘ê·¼ì„± ë¦¬í¬íŠ¸ ì²˜ë¦¬ ì‹¤íŒ¨:', e.message);
              }
            }
            
            // Lighthouse ë¦¬í¬íŠ¸ ìˆ˜ì§‘
            const lighthousePath = './artifacts/lighthouse-report';
            if (fs.existsSync(lighthousePath)) {
              try {
                const lighthouseFile = path.join(lighthousePath, 'lighthouse-report.json');
                if (fs.existsSync(lighthouseFile)) {
                  const lighthouse = JSON.parse(fs.readFileSync(lighthouseFile, 'utf8'));
                  report.results.performance = {
                    performance: Math.round(lighthouse.categories.performance.score * 100),
                    accessibility: Math.round(lighthouse.categories.accessibility.score * 100),
                    bestPractices: Math.round(lighthouse.categories['best-practices'].score * 100),
                    seo: Math.round(lighthouse.categories.seo.score * 100)
                  };
                }
              } catch (e) {
                console.log('Lighthouse ë¦¬í¬íŠ¸ ì²˜ë¦¬ ì‹¤íŒ¨:', e.message);
              }
            }
            
            fs.writeFileSync('comprehensive-report.json', JSON.stringify(report, null, 2));
            
            console.log('ğŸ“Š ì¢…í•© í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸');
            console.log('='.repeat(40));
            console.log('ğŸ•’ ì‹œê°„:', report.timestamp);
            console.log('ğŸ”— ì»¤ë°‹:', report.commit?.substring(0, 8));
            console.log('ğŸŒ¿ ë¸Œëœì¹˜:', report.branch);
            
            if (report.results.accessibility) {
              console.log('â™¿ ì ‘ê·¼ì„±:');
              console.log('  - Pa11y ì´ìŠˆ:', report.results.accessibility.pa11y.issues);
              console.log('  - Axe ìœ„ë°˜ì‚¬í•­:', report.results.accessibility.axe.violations);
            }
            
            if (report.results.performance) {
              console.log('âš¡ ì„±ëŠ¥:');
              console.log('  - ì„±ëŠ¥ ì ìˆ˜:', report.results.performance.performance);
              console.log('  - ì ‘ê·¼ì„± ì ìˆ˜:', report.results.performance.accessibility);
              console.log('  - ëª¨ë²”ì‚¬ë¡€:', report.results.performance.bestPractices);
              console.log('  - SEO:', report.results.performance.seo);
            }
          "
        env:
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_WORKFLOW: ${{ github.workflow }}

      - name: ğŸ“¤ Upload comprehensive report
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-report
          path: comprehensive-report.json
          retention-days: 90
